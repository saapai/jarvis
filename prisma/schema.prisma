generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [pgvector(schema: "public")]
}

// ============================================
// MULTI-SPACE CORE MODELS
// ============================================

model User {
  id          String   @id @default(cuid())
  phoneNumber String   @unique
  name        String?
  createdAt   DateTime @default(now())

  // Relations
  spacesOwned Space[]       @relation("SpaceOwner")
  memberships SpaceMember[]
}

model Space {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  joinCode  String   @unique // e.g. "SEP", "MYCLUB" - for SMS JOIN command
  ownerId   String
  owner     User     @relation("SpaceOwner", fields: [ownerId], references: [id])
  createdAt DateTime @default(now())

  // Config for legacy integrations
  airtableBaseId    String? // If set, use Airtable for this space
  airtableTableName String?

  // Relations
  members                SpaceMember[]
  messages               Message[]
  conversationStates     ConversationState[]
  announcementDrafts     AnnouncementDraft[]
  polls                  PollMeta[]
  events                 Event[]
  uploads                Upload[]
  slackSyncs             SlackSync[]
  scheduledAnnouncements ScheduledAnnouncement[]
  invites                SpaceInvite[]
  facts                  Fact[]

  @@index([joinCode])
}

model SpaceMember {
  id       String   @id @default(cuid())
  spaceId  String
  space    Space    @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  userId   String
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role     String   @default("member") // "owner", "admin", "member"
  name     String? // Display name within this space
  joinedAt DateTime @default(now())
  optedOut Boolean  @default(false)

  @@unique([spaceId, userId])
  @@index([spaceId])
  @@index([userId])
}

model SpaceInvite {
  id        String    @id @default(cuid())
  spaceId   String
  space     Space     @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  code      String    @unique // Random invite code for web links
  expiresAt DateTime?
  maxUses   Int?
  uses      Int       @default(0)
  createdAt DateTime  @default(now())

  @@index([spaceId])
  @@index([code])
}

// ============================================
// CONTENT MODELS
// ============================================

model Upload {
  id        String   @id @default(cuid())
  name      String
  rawText   String
  createdAt DateTime @default(now())

  // Space scope
  spaceId String?
  space   Space?  @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  facts Fact[]

  @@index([spaceId])
}

model Fact {
  id       String @id @default(cuid())
  uploadId String
  upload   Upload @relation(fields: [uploadId], references: [id], onDelete: Cascade)

  content       String // Summary/key point
  sourceText    String? // Original full text chunk
  category      String // social, professional, pledging, events, meetings, other
  subcategory   String? // Event name like "Study Hall", "Creatathon"
  timeRef       String? // "tomorrow", "November 8th", "every Wednesday"
  dateStr       String? // Parsed date: "2024-11-08", "recurring:wednesday"
  calendarDates String? // JSON array of YYYY-MM-DD dates for calendar display
  entities      String // JSON array of entities
  embedding     Unsupported("vector")?

  parentId String?
  parent   Fact?   @relation("FactTree", fields: [parentId], references: [id])
  children Fact[]  @relation("FactTree")

  linkedEvents Event[] // Events linked to this fact

  // Space scope
  spaceId String?
  space   Space?  @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([spaceId])
}

model Message {
  id          String   @id @default(cuid())
  phoneNumber String
  direction   String // "inbound" or "outbound"
  text        String
  meta        String? // JSON: {draftId, pollId, tags}
  createdAt   DateTime @default(now())

  // Space scope
  spaceId String?
  space   Space?  @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  @@index([phoneNumber, createdAt])
  @@index([spaceId, phoneNumber, createdAt])
}

model ConversationState {
  id           String   @id @default(cuid())
  phoneNumber  String
  stateType    String? // "onboarding", "draft_announcement", "answering_poll"
  statePayload String? // JSON: task-specific context
  updatedAt    DateTime @default(now())

  // Space scope - which space this conversation state belongs to
  spaceId String?
  space   Space?  @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  // Track which space user is currently interacting with (for SMS routing)
  activeSpaceId String?

  @@unique([phoneNumber, spaceId])
  @@index([phoneNumber])
  @@index([spaceId])
}

model AnnouncementDraft {
  id                String   @id @default(cuid())
  phoneNumber       String
  draftText         String
  structuredPayload String? // JSON: {event, time, date, tone, audience}
  status            String // "in_progress" or "finalized"
  createdAt         DateTime @default(now())
  updatedAt         DateTime @default(now())

  // Space scope
  spaceId String?
  space   Space?  @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  @@index([phoneNumber, status])
  @@index([spaceId, phoneNumber, status])
}

model PollMeta {
  id                  String   @id @default(cuid())
  questionText        String
  requiresReasonForNo Boolean  @default(false)
  isActive            Boolean  @default(true)
  createdBy           String // phone number
  createdAt           DateTime @default(now())

  // Space scope
  spaceId String?
  space   Space?  @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  responses PollResponse[]

  @@index([isActive, createdAt])
  @@index([spaceId, isActive, createdAt])
}

model PollResponse {
  id          String   @id @default(cuid())
  pollId      String
  poll        PollMeta @relation(fields: [pollId], references: [id], onDelete: Cascade)
  phoneNumber String
  response    String // "Yes", "No", "Maybe"
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())

  @@unique([pollId, phoneNumber])
  @@index([pollId, phoneNumber])
}

model Event {
  id                  String   @id @default(cuid())
  title               String // Event name/title
  description         String? // Full description
  eventDate           DateTime // When the event occurs
  location            String? // Where it happens
  createdBy           String // Phone number of creator
  category            String? // Type of event (social, professional, etc.)
  reminderSent        Boolean  @default(false) // Has 2-hour reminder been sent?
  morningReminderSent Boolean  @default(false) // Has 9am reminder been sent?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @default(now())

  // Space scope
  spaceId String?
  space   Space?  @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  // Optional link to extracted facts
  linkedFactId String?
  linkedFact   Fact?   @relation(fields: [linkedFactId], references: [id])

  @@index([eventDate, reminderSent])
  @@index([eventDate, morningReminderSent])
  @@index([spaceId, eventDate])
}

model SlackSync {
  id           String   @id @default(cuid())
  channelName  String
  lastSyncedTs String? // Slack timestamp of last synced message
  lastSyncedAt DateTime @default(now())
  updatedAt    DateTime @default(now())

  // Space scope
  spaceId String?
  space   Space?  @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  @@unique([spaceId, channelName])
  @@index([spaceId])
}

model ScheduledAnnouncement {
  id              String    @id @default(cuid())
  content         String // Message content to send
  scheduledFor    DateTime // When to send it
  sent            Boolean   @default(false)
  sentAt          DateTime?
  sourceFactId    String? // Optional link to Fact that created this
  sourceMessageTs String? // Slack message timestamp
  createdAt       DateTime  @default(now())

  // Space scope
  spaceId String?
  space   Space?  @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  @@index([scheduledFor, sent])
  @@index([spaceId, scheduledFor, sent])
}
